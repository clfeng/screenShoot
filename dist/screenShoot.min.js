
let topImg=document.getElementById('top_img');let bottomImg=document.getElementById('bottom_img');let contentLeft=document.getElementById('content_left');let imgWrap=document.getElementById('imgWrap');let rightImg=document.getElementById('rightImg');let saveImg=document.getElementById('saveImg');let clipDiv=document.getElementById('clipDiv');let saveBtn=document.getElementById('saveBtn');const _CLIP_WIDTH=200;const _CLIP_HEIGHT=200;let oldImgW=topImg.offsetWidth;let oldImgH=topImg.offsetHeight;let imgScale=oldImgW/oldImgH;let conLeftW=contentLeft.offsetWidth;let conLeftH=contentLeft.offsetHeight;let contScale=conLeftW/conLeftH;let TClear,LClear;let scallFlag=contScale>imgScale;if(scallFlag){setHeight(conLeftH);}else{setWidth(conLeftW);}
center();clip();addEvent(contentLeft,"mousedown",mouseDown);function mouseDown(event){clearInterval(TClear);clearInterval(LClear);event=getEvent(event);stopDefault(event);let mouseL=event.clientX;let mouseT=event.clientY;let distX=mouseL-topImg.offsetLeft;let distY=mouseT-topImg.offsetTop;if(this.setCapture){this.setCapture();}
addEvent(contentLeft,"mousemove",mouseMove);function mouseMove(event){event=getEvent(event);stopDefault(event);let clear=setInterval(function(){clearInterval(clear);topImg.style.top=bottomImg.style.top=(event.clientY-distY)+"px";topImg.style.left=bottomImg.style.left=(event.clientX-distX)+"px";clip()},16.7)}
if(!this.setCapture){addEvent(document,"mouseup",mouseup);}else{addEvent(contentLeft,"mouseup",mouseup);}
function mouseup(event){event=getEvent(event);stopDefault(event);let directionX=(event.clientX-mouseL)>0?true:false;let directionY=(event.clientY-mouseT)>0?true:false;if(directionY&&topImg.offsetTop>clipDiv.offsetTop-100){changePlaceT(topImg.offsetTop,clipDiv.offsetTop-100,'top');}else if(!directionY&&topImg.offsetTop+topImg.offsetHeight<clipDiv.offsetTop-100+clipDiv.offsetHeight){changePlaceT(topImg.offsetTop,clipDiv.offsetTop-100+clipDiv.offsetHeight-topImg.offsetHeight,'top');}
if(directionX&&topImg.offsetLeft>clipDiv.offsetLeft-100){changePlaceL(topImg.offsetLeft,clipDiv.offsetLeft-100,'left');}else if(!directionX&&topImg.offsetLeft+topImg.offsetWidth<clipDiv.offsetLeft-100+clipDiv.offsetWidth){changePlaceL(topImg.offsetLeft,clipDiv.offsetLeft-100+clipDiv.offsetWidth-topImg.offsetWidth,'left');}
removeEvent(contentLeft,"mousemove",mouseMove);if(this.releaseCapture){this.releaseCapture()
removeEvent(contentLeft,"mouseup",mouseup);}else{removeEvent(document,'mouseup',mouseup);}}}
addEvent(contentLeft,'mousewheel',function(event){event=getEvent(event);if(event.wheelDelta>0){stopDefault(event);scalBig();}else if(event.wheelDelta<0){stopDefault(event);scalSmall();}});addEvent(contentLeft,'DOMMouseScroll',function(event){event=getEvent(event);if(event.detail>0){stopDefault(event);scalSmall();}else if(event.deail<0){stopDefault(event);scalBig();}});addEvent(saveBtn,"click",function(){let rightImgStyle=window.getComputedStyle(rightImg,null),img,children;children=imgWrap.children;if(children.length>1){imgWrap.removeChild(children[children.length-1]);}
img=new Image();img.src=rightImg.src;img.onload=function(){img.style.height=rightImgStyle['height'];img.style.clip=rightImgStyle['clip'];img.style.marginTop=rightImgStyle['margin-top'];img.style.marginLeft=rightImgStyle['margin-left'];rightImg.style.display='none';imgWrap.appendChild(img);saveCanvas();}
function saveCanvas(){let imgCanvas=document.createElement('canvas');let ctx=imgCanvas.getContext('2d');imgCanvas.width=clipDiv.offsetWidth;imgCanvas.height=clipDiv.offsetHeight;let rightImgStyle=window.getComputedStyle(rightImg,null);let sx=(-parseInt(rightImgStyle['margin-left']))/topImg.offsetWidth*oldImgW;let sy=(-parseInt(rightImgStyle['margin-top']))/topImg.offsetHeight*oldImgH;let sWidth=_CLIP_WIDTH/topImg.offsetWidth*oldImgW;let sHeight=_CILP_HEIGHT/topImg.offsetHeight*oldImgH;ctx.drawImage(topImg,parseInt(sx),parseInt(sy),parseInt(sWidth),parseInt(sHeight),0,0,_CLIP_WIDTH,_CLIP_HEIGHT);let imgBase64=imgCanvas.toDataURL('image/png');}});let scalClear;function scalSmall(){clearInterval(scalClear);if(scallFlag){let oldH=topImg.offsetHeight,targetH=oldH*0.95;scalClear=setInterval(function(){if(oldH<targetH){clearInterval(scalClear);setHeight(targetH);clip();}else{let speed=Math.floor((targetH-oldH)/10);oldH+=speed;setHeight(oldH);clip();}},20);}else{let oldW=topImg.offsetWidth,targetW=oldW*0.95;scalClear=setInterval(function(){if(oldW<targetW){clearInterval(scalClear);setWidth(targetW);clip();}else{clearInterval(scalClear);let speed=Math.floor((targetW-oldW)/10);oldW+=speed;setWidth(oldW);clip();}},20);}}
function scalBig(){clearInterval(scalClear);if(scallFlag){let oldH=topImg.offsetHeight,targetH=oldH*1.05;scalClear=setInterval(function(){if(oldH>targetH){clearInterval(scalClear);setHeight(targetH);clip();}else{let speed=Math.ceil((targetH-oldH)/10);oldH+=speed;setHeight(oldH);clip();}},20);}else{let oldW=topImg.offsetWidth,targetW=oldW*1.05;scalClear=setInterval(function(){if(oldW>targetW){clearInterva(scalClear);setWidth(oldW);clip();}else{let speed=Math.ceil((targetW-oldW)/10);oldW+=speed;setWidth(oldW);clip();}},20);}}
function changePlaceT(old,target,type){clearInterval(TClear);let speed,flag=target-old>0?true:false;if(flag){TClear=setInterval(function(){if(target>old){speed=Math.ceil((target-old)/10);old+=speed;topImg.style[type]=bottomImg.style[type]=old+'px';}else{clearInterval(TClear);topImg.style[type]=bottomImg.style[type]=target+'px';}
clip();},30);}else{TClear=setInterval(function(){if(target<old){speed=Math.ceil((target-old)/10);old+=speed;topImg.style[type]=bottomImg.style[type]=old+'px';}else{clearInterval(TClear);topImg.style[type]=bottomImg.style[type]=target+'px';}
clip();},30);}}
function changePlaceL(old,target,type){clearInterval(LClear);let speed,flag=target-old>0?true:false;if(flag){LClear=setInterval(function(){if(target>old){speed=Math.ceil((target-old)/10);old+=speed;topImg.style[type]=bottomImg.style[type]=old+'px';}else{clearInterval(LClear);topImg.style[type]=bottomImg.style[type]=target+'px';}
clip();},30);}else{LClear=setInterval(function(){if(target<old){speed=Math.ceil((target-old)/10);old+=speed;topImg.style[type]=bottomImg.style[type]=old+'px';}else{clearInterval(LClear);topImg.style[type]=bottomImg.style[type]=target+'px';}
clip();},30);}}
function clip(){let clipTop=clipDiv.offsetTop-100-topImg.offsetTop;let clipLeft=clipDiv.offsetLeft-100-topImg.offsetLeft;rightImg.style.clip=topImg.style.clip='rect('+clipTop+'px,'+(clipLeft+_CLIP_WIDTH)+'px,'+(clipTop+_CLIP_HEIGHT)+'px,'+clipLeft+'px)';rightImg.style.marginTop=-clipTop+'px';rightImg.style.marginLeft=-clipLeft+'px';}
function center(){let marginT=conLeftH-topImg.offsetHeght;let marginL=conLeftW-topImg.offsetWidth;topImg.style.top=bottomImg.style.top=parseInt(marginT/2)+"px";topImg.style.left=bottomImg.style.left=parseInt(marginL/2)+"px";}
function setHeight(h){rightImg.style.height=topImg.style.height=bottomImg.style.height=h+"px";}
function setWidth(w){rightImg.style.width=topImg.style.width=bottomImg.style.width=w+"px";}